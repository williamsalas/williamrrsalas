<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>william salas | software dev</title>
    <link rel="stylesheet" href="./assets/css/styles.css" />
    <link rel="icon" href="./favicon.ico" sizes="any" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="mask-icon" href="./safari-pinned-tab.svg" color="#00ADB5" />
    <link rel="manifest" href="./site.webmanifest" />
    <meta name="theme-color" content="#222831" />
  </head>
  <body class="flex-container" style="justify-content: flex-start">
    <h2>hi, i'm william salas ðŸ‘‹</h2>
    <small>software developer from southern california</small>
    <small>
      part of Redfinâ€™s search team building the siteâ€™s most visited pages,
      search and home details
    </small>

    <img
      src="assets/img/pikaconstruction.gif"
      class="pikachu"
      alt="Under Construction"
    />
    <div id="pikachu-counter" class="pikachu-counter"></div>
    <div class="bottom-flex-container">
      <div class="bottom-left">
        <h3>recent activity</h3>
        <p id="github-events" class="github-events">
          Loading recent GitHub activity...
        </p>
      </div>
    </div>
    <script>
      (async function () {
        // Pikachu construction start date: August 22, 2025
        const startDate = new Date("2025-08-22T00:00:00Z");
        const today = new Date();
        const diffTime = today - startDate;
        const diffDays = Math.max(
          0,
          Math.floor(diffTime / (1000 * 60 * 60 * 24))
        );
        const counterElement = document.getElementById("pikachu-counter");
        if (counterElement) {
          counterElement.textContent = `pikachu has been working on this website for ${diffDays} day${
            diffDays === 1 ? "" : "s"
          }!`;
        }

        // Fetch and display GitHub activity from github-data.json
        const container = document.getElementById("github-events");
        if (!container) return;

        try {
          const res = await fetch("data/github-data.json", {
            cache: "no-store",
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          if (!Array.isArray(data) || data.length === 0) {
            container.textContent = "No recent GitHub activity.";
            return;
          }

          // Group PR events by repo
          const seenPRs = new Set();
          const repoMap = new Map();
          data
            .filter(
              (event) =>
                !(
                  event.type === "PullRequestEvent" &&
                  event.title &&
                  event.title.startsWith("chore(data")
                )
            )
            .filter((event) => {
              if (event.type !== "PullRequestEvent" || !event.pr_number)
                return true;
              if (seenPRs.has(event.pr_number)) return false;
              seenPRs.add(event.pr_number);
              return true;
            })
            .forEach((event) => {
              const repoName =
                event?.repo && event.repo.name
                  ? event.repo.name
                  : event?.repo || "unknown";
              if (event.type === "PullRequestEvent") {
                if (!repoMap.has(repoName)) repoMap.set(repoName, []);
                repoMap.get(repoName).push(event);
              }
            });

          // Create the display
          const fragment = document.createDocumentFragment();
          for (const [repoName, events] of repoMap.entries()) {
            const repoHeader = document.createElement("div");
            repoHeader.style.fontWeight = "bold";
            repoHeader.style.marginTop = "1em";
            repoHeader.style.marginBottom = "0.2em";
            repoHeader.textContent = repoName;
            fragment.appendChild(repoHeader);

            const ul = document.createElement("ul");
            ul.style.paddingLeft = "0";
            ul.style.margin = "0 0 0.5em 0";
            ul.style.listStyle = "none";

            events.forEach((event) => {
              const createdAt = event?.created_at
                ? new Date(event.created_at)
                : null;
              const li = document.createElement("li");
              li.style.marginBottom = "8px";

              // status image
              const statusIcon = document.createElement("img");
              statusIcon.width = 16;
              statusIcon.height = 16;
              statusIcon.style.verticalAlign = "middle";
              statusIcon.style.marginLeft = "2px";
              statusIcon.style.marginRight = "6px";
              if (event.action === "opened" || event.merged === false) {
                statusIcon.src = "assets/img/git-pull-request-16.svg";
                statusIcon.alt = "PR open";
              } else if (event.merged) {
                statusIcon.src = "assets/img/git-merge-16.svg";
                statusIcon.alt = "PR merged";
              } else {
                statusIcon.src = "assets/img/git-pull-request-closed-16.svg";
                statusIcon.alt = "PR closed";
              }

              // PR title hyperlinked to the PR
              const titleLink = document.createElement("a");
              titleLink.href = event.url;
              titleLink.target = "_blank";
              titleLink.rel = "noopener noreferrer";
              titleLink.textContent = event.title || "(no title)";
              titleLink.style.fontWeight = "bold";
              titleLink.style.maxWidth = "60vw";
              titleLink.style.display = "inline-block";
              titleLink.style.overflow = "hidden";
              titleLink.style.textOverflow = "ellipsis";
              titleLink.style.verticalAlign = "middle";
              titleLink.style.whiteSpace = "nowrap";

              const small = document.createElement("small");
              if (createdAt) {
                const month = createdAt.toLocaleString("en-US", {
                  month: "short",
                });
                const day = createdAt.getDate();
                small.textContent = `${month} ${day}`;
              } else {
                small.textContent = "";
              }
              small.style.marginLeft = "0.5em";
              small.style.float = "right";
              small.style.textAlign = "right";
              small.style.display = "block";
              li.append(statusIcon, titleLink, small);
              ul.appendChild(li);
            });
            fragment.appendChild(ul);
          }

          // Show non-PR events as before
          const ulOther = document.createElement("ul");
          ulOther.style.paddingLeft = "0";
          ulOther.style.margin = "0";
          ulOther.style.listStyle = "none";
          data
            .filter((event) => event.type !== "PullRequestEvent")
            .forEach((event) => {
              const type = (event?.type || "").replace("Event", "");
              const repoName =
                event?.repo && event.repo.name
                  ? event.repo.name
                  : event?.repo || "unknown";
              const createdAt = event?.created_at
                ? new Date(event.created_at)
                : null;
              const li = document.createElement("li");
              li.style.marginBottom = "8px";
              const b = document.createElement("b");
              b.textContent = type;
              const code = document.createElement("code");
              code.textContent = repoName;
              const br = document.createElement("br");
              const small = document.createElement("small");
              if (createdAt) {
                const month = createdAt.toLocaleString("en-US", {
                  month: "short",
                });
                const day = createdAt.getDate();
                small.textContent = `${month} ${day}`;
              } else {
                small.textContent = "";
              }
              small.style.float = "right";
              small.style.textAlign = "right";
              small.style.display = "block";
              li.append(b, document.createTextNode(" on "), code, br, small);
              ulOther.appendChild(li);
            });
          fragment.appendChild(ulOther);

          container.replaceChildren(fragment);
        } catch (err) {
          container.textContent = `Could not load GitHub activity. ${err.message}`;
          console.error(err);
        }
      })();
    </script>
  </body>
</html>
